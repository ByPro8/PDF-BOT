<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Suck My PDF</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f1f3f6;
    }

    /* ---------- LAYOUT ---------- */

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      height: 100vh;
    }

    /* ---------- SIDEBAR ---------- */

    .sidebar {
      background: #1f2933;
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar h2 {
      margin: 0 0 12px 0;
      text-align: center;
      font-size: 20px;
    }

    .sidebar input,
    .sidebar select,
    .sidebar button {
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }

    .sidebar input,
    .sidebar select {
      border-radius: 4px;
      border: none;
    }

    .sidebar button {
      background: #3b82f6;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }

    .sidebar button:hover {
      background: #2563eb;
    }

    .sidebar button.red {
      background: #dc2626;
    }

    .sidebar button.red:hover {
      background: #b91c1c;
    }

    .sidebar button.gray {
      background: #6b7280;
    }

    .sidebar button.gray:hover {
      background: #4b5563;
    }

    /* ---------- MAIN ---------- */

    .main {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ---------- TOP BAR ---------- */

    .topbar {
      background: white;
      border-radius: 6px;
      padding: 8px;
      display: flex;
      gap: 6px;
      align-items: stretch;
      overflow-x: auto;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .topbar input,
    .topbar select {
      padding: 6px;
      font-size: 14px;
    }

    .topbar button {
      padding: 6px 12px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .topbar button:hover {
      background: #1d4ed8;
    }

    /* ---------- TERMINAL ---------- */

    .terminal {
      flex: 1;
      background: #0f172a;
      color: #00ff9c;
      padding: 16px;
      border-radius: 6px;
      overflow-y: auto;
      font-family: Consolas, monospace;
      font-size: 14px;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6);
    }

    /* ---------- BUTTON ---------- */

    .open-btn {
      display: inline-block;
      padding: 4px 10px;
      background: #22c55e;
      color: white;
      border-radius: 4px;
      text-decoration: none;
      font-size: 12px;
      margin-top: 6px;
    }

    .open-btn:hover {
      background: #16a34a;
    }

    /* ----- TOPBAR BLOCKS ----- */

    .block {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 8px 12px;
      border-right: 1px solid #e5e7eb;
      min-width: 220px;
    }

    .block:last-child {
      border-right: none;
    }

    .title {
      font-size: 12px;
      color: #6b7280;
      font-weight: bold;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
  </style>
</head>


<body>

  <div class="app">

    <!-- ================= SIDEBAR ================= -->

    <div class="sidebar">

      <input id="adminPass" type="password" placeholder="Password">

      <input id="fileId" placeholder="File ID">

      <select id="newLabel">
        <option value="real">Real</option>
        <option value="fake">Fake</option>
      </select>

      <button onclick="updateLabel()">Change Label</button>

      <button class="red" onclick="deleteFile()">Delete File</button>

      <button onclick="loadAdminLogs()">Show Logs</button>

      <button onclick="showAdminLinks()">Admin Links</button>

      <button class="gray" onclick="clearLog()">Clear Terminal</button>

    </div>


    <!-- ================= MAIN ================= -->

    <div class="main">


      <!-- ---------- TOP BAR ---------- -->

      <div class="topbar">


        <!-- ===== CHECK ===== -->
        <div class="block">

          <div class="title">üîç Check</div>

          <input id="checkFile" type="file" accept="application/pdf">

          <button onclick="checkPdf()">Check PDF</button>

        </div>


        <!-- ===== ADD ===== -->
        <div class="block">

          <div class="title">‚ûï Add</div>

          <input id="addFile" type="file" accept="application/pdf" multiple>

          <select id="label">
            <option value="real">Real</option>
            <option value="fake">Fake</option>
          </select>

          <button onclick="addPdf()">Add PDF to DB</button>

        </div>


        <!-- ===== DATABASE ===== -->
        <div class="block">

          <div class="title">üìÇ Database</div>

          <button onclick="loadDB()">Show Database</button>

          <input id="searchBox" placeholder="Search filename">

          <button onclick="searchDB()">Search in DB</button>

          <button onclick="downloadDB()">Download Database</button>

        </div>


      </div>


      <!-- ---------- TERMINAL ---------- -->

      <div id="out" class="terminal">
        ...
      </div>


    </div>

  </div>

</body>
<script>

  const outEl = document.getElementById("out");

  const show = (t) => {
    outEl.textContent = t;
  };

  function clearLog() {
    show("Cleared.");
  }


  // ================= CHECK =================

  async function checkPdf() {

    const f = document.getElementById("checkFile").files[0];

    if (!f) {
      show("‚ùå Pick a PDF first");
      return;
    }

    show("‚è≥ Checking PDF...");

    const fd = new FormData();
    fd.append("file", f);

    try {

      const r = await fetch("/check", {
        method: "POST",
        body: fd
      });

      const j = await r.json();

      // Match found
      if (j.matched_with) {

        const link = location.origin + j.matched_with.url;

        outEl.innerHTML =
          j.message + "<br><br>" +
          `#${j.matched_with.id} | ${j.matched_with.filename}<br>` +
          `<a class="open-btn" target="_blank" href="${link}">Open PDF</a>`;

        return;
      }

      show(j.message || "Error");

    } catch {

      show("‚ùå Server error while checking");

    }
  }


  // ================= ADD =================

  async function addPdf() {

    const fileInput = document.getElementById("addFile");
    const labelSelect = document.getElementById("label");
    const passInput = document.getElementById("adminPass");

    const files = fileInput.files;   // <-- MULTIPLE FILES
    const label = labelSelect.value;

    if (!files.length) {
      show("‚ùå Pick at least one PDF");
      return;
    }

    show(`‚è≥ Uploading ${files.length} PDF(s)...`);

    let resultText = "";

    // Upload one by one
    for (let i = 0; i < files.length; i++) {

      const f = files[i];

      const fd = new FormData();
      fd.append("label", label);
      fd.append("file", f);

      try {

        const r = await fetch("/add", {
          method: "POST",
          body: fd
        });

        const j = await r.json();

        // ---- DUPLICATE ----
        if (j.error === "DUPLICATE" && j.existing) {

          resultText += `‚ùå ${f.name} ‚Üí DUPLICATE (id=${j.existing.id})\n`;

        }

        // ---- SUCCESS ----
        else if (j.message) {

          resultText += `‚úÖ ${f.name} ‚Üí ADDED\n`;

        }

        // ---- OTHER ERROR ----
        else {

          resultText += `‚ö†Ô∏è ${f.name} ‚Üí ERROR\n`;

        }

      } catch {

        resultText += `‚ùå ${f.name} ‚Üí SERVER ERROR\n`;

      }
    }

    // Show results
    show(resultText);

    // Reset inputs
    fileInput.value = "";
    labelSelect.value = "real";
    if (passInput) passInput.value = "";
  }


  // ================= DATABASE =================

  async function loadDB() {

    show("‚è≥ Loading database...");

    try {

      const r = await fetch("/files");

      if (!r.ok) {
        throw new Error();
      }

      const list = await r.json();

      if (!list.length) {
        show("üìÇ Database is empty");
        return;
      }

      let html = "<b>üìÇ DATABASE FILES</b><br><br>";

      list.forEach(f => {

        const link = location.origin + "/open/" + f.id;

        html += `#${f.id} | ${f.label.toUpperCase()} | ${f.filename}<br>`;
        html += `<a class="open-btn" target="_blank" href="${link}">Open PDF</a><br><br>`;

      });

      outEl.innerHTML = html;

    } catch {

      show("‚ùå Failed to load database");

    }
  }


  // ================= SEARCH =================

  async function searchDB() {

    const q = document.getElementById("searchBox").value;

    if (!q) {
      show("‚ùå Enter search text");
      return;
    }

    show("‚è≥ Searching...");

    try {

      const r = await fetch("/search?q=" + encodeURIComponent(q));
      const list = await r.json();

      if (!list.length) {
        show("No results");
        return;
      }

      let html = "<b>üîç SEARCH RESULTS</b><br><br>";

      list.forEach(f => {

        const link = location.origin + "/open/" + f.id;

        html += `#${f.id} | ${f.label.toUpperCase()} | ${f.filename}<br>`;
        html += `<a class="open-btn" target="_blank" href="${link}">Open PDF</a><br><br>`;

      });

      outEl.innerHTML = html;

    } catch {

      show("‚ùå Search failed");

    }
  }


  // ================= LABEL =================

  async function updateLabel() {

    const id = document.getElementById("fileId").value.trim();
    const pw = document.getElementById("adminPass").value.trim();
    const label = document.getElementById("newLabel").value;

    if (!id || isNaN(id)) {
      show("‚ùå Enter valid file ID");
      return;
    }

    if (!pw) {
      show("‚ùå Enter admin password");
      return;
    }

    show("‚è≥ Updating label...");

    const fd = new FormData();

    fd.append("file_id", id);
    fd.append("label", label);
    fd.append("password", pw);

    try {

      const r = await fetch("/admin/label", {
        method: "POST",
        body: fd
      });

      const j = await r.json();

      show(j.message || JSON.stringify(j));

    } catch {

      show("‚ùå Server error");

    }

    document.getElementById("adminPass").value = "";
  }


  // ================= DELETE =================

  async function deleteFile() {

    const id = document.getElementById("fileId").value.trim();
    const pw = document.getElementById("adminPass").value.trim();

    if (!id || isNaN(id)) {
      show("‚ùå Enter valid file ID");
      return;
    }

    if (!pw) {
      show("‚ùå Enter admin password");
      return;
    }

    if (!confirm("Are you sure you want to delete this file?")) {
      return;
    }

    show("‚è≥ Deleting...");

    const fd = new FormData();

    fd.append("file_id", id);
    fd.append("password", pw);

    try {

      const r = await fetch("/admin/delete", {
        method: "POST",
        body: fd
      });

      const j = await r.json();

      show(j.message || JSON.stringify(j));

    } catch {

      show("‚ùå Server error");

    }

    document.getElementById("adminPass").value = "";
  }


  // ================= ADMIN =================

  function showAdminLinks() {

    show(
      "ADMIN LINKS\n\n" +
      location.origin + "/admin/reset_db\n" +
      location.origin + "/admin/logs"
    );
  }


  async function loadAdminLogs() {

    show("‚è≥ Loading logs...");

    try {

      const r = await fetch("/admin/logs");
      const list = await r.json();

      if (!list.length) {
        show("No admin logs");
        return;
      }

      let out = "ADMIN LOGS\n\n";

      list.forEach(l => {

        out += `[${l.created_at}] ${l.action}`;

        if (l.details) {
          out += " (" + l.details + ")";
        }

        out += "\n";

      });

      show(out);

    } catch {

      show("‚ùå Failed to load logs");

    }
  }


  // ================= DOWNLOAD =================

  function downloadDB() {

    window.open(location.origin + "/admin/export", "_blank");

  }

</script>

</html>