<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Suck My PDF</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    .app {
      display: grid;
      grid-template-columns: 1fr;
      height: 100vh;
    }

    .main {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: #020617;
      min-height: 0;
    }

    .topbar {
      background: #020617;
      border-radius: 6px;
      padding: 8px;
      display: flex;
      gap: 6px;
      align-items: stretch;
      overflow-x: auto;
      border: 1px solid #1e293b;
    }

    .topbar input {
      padding: 6px;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1e293b;
      border-radius: 4px;
    }

    .topbar button {
      padding: 6px 12px;
      background: #1d4ed8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .topbar button:hover {
      background: #2563eb;
    }

    .terminal {
      flex: 1;
      min-height: 0;
      background: #0f172a;
      padding: 12px;
      border-radius: 6px;
      font-family: Consolas, monospace;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.8);
      border: 1px solid #1e293b;
    }

    /* GRID OUTPUT (3 per row) */
    #out {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-content: flex-start;
    }

    /* Each log block as a card */
    pre {
      margin: 0;
      white-space: pre-wrap;
      color: #00ff9c;

      background: #020617;
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 12px;

      box-sizing: border-box;
      flex: 1 1 calc(33.333% - 10px);
      min-width: 320px;
    }

    /* Batch header / single messages should span full width */
    pre.full {
      flex: 0 0 100%;
      min-width: 100%;
    }

    /* 2 columns sooner (<= 1250px) */
    @media (max-width: 1250px) {
      pre {
        flex: 1 1 calc(50% - 10px);
      }
    }

    /* Optional: 1 column on small screens */
    @media (max-width: 700px) {
      pre {
        flex: 1 1 100%;
        min-width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="main">
      <div class="topbar">
        <div class="block">
          <div class="title">üîç Check PDF</div>
          <input id="checkFile" type="file" accept="application/pdf" />
          <button id="checkBtn" onclick="checkPdf()">Check PDF</button>
        </div>

        <div class="block">
          <div class="title">üì¶ Check PDFs (batch)</div>
          <input id="checkFiles" type="file" accept="application/pdf" multiple />
          <button id="batchBtn" onclick="checkPdfBatch()">Check Batch</button>
        </div>
      </div>

      <div class="terminal">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <button onclick="clearLog()"
            style="background:#374151;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px">
            Clear
          </button>
        </div>

        <div id="out">
          <pre class="full">...</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    const outEl = document.getElementById("out");
    const BLUE = "#00e5ff";

    const btnSingle = document.getElementById("checkBtn");
    const btnBatch = document.getElementById("batchBtn");

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function showPre(htmlInsidePre) {
      outEl.innerHTML = "";
      const pre = document.createElement("pre");
      pre.className = "full";
      pre.innerHTML = htmlInsidePre;
      outEl.appendChild(pre);
      outEl.scrollTop = outEl.scrollHeight;
      return pre;
    }

    function appendPre(htmlInsidePre, fullWidth = false) {
      const pre = document.createElement("pre");
      if (fullWidth) pre.classList.add("full");
      pre.innerHTML = htmlInsidePre;
      outEl.appendChild(pre);
      outEl.scrollTop = outEl.scrollHeight;
      return pre;
    }

    function clearLog() {
      showPre("Cleared.");
    }

    function makeProcessingBlock(filename) {
      return `‚è≥ Processing: ${escapeHtml(filename)}\n`;
    }

    // IBAN without spaces: TR410006400000114790226901
    function formatIban(v) {
      const raw = String(v ?? "").trim();
      if (!raw) return raw;

      const compact = raw.replace(/\s+/g, "").toUpperCase();
      if (!compact.startsWith("TR") || compact.length < 10) return raw;

      return compact;
    }

    function formatData(data) {
      if (!data || typeof data !== "object") return escapeHtml(JSON.stringify(data));

      const order = [
        "tr_status",
        "sender_name",
        "receiver_name",
        "receiver_iban",
        "amount",
        "transaction_time",
        "receipt_no",
        "transaction_ref",
        "error",
      ];

      const pad = 18;

      const statusDisplay = (v) => {
        const raw = String(v ?? "");
        const st = raw.toLowerCase();

        if (st.includes("completed")) return { text: "‚úÖ", color: "#00ffa6" };

        if (!st || st.includes("unknown")) {
          return {
            text: raw || "unknown ‚Äî PDF does not state status; check manually",
            color: "#ffd166",
          };
        }

        if (st.includes("pending")) return { text: raw, color: "#ffd166" };

        return { text: raw, color: "#ff4d4d" };
      };

      const valueColor = (k, v) => {
        if (k === "tr_status") return statusDisplay(v).color;
        if (k === "receiver_name") return BLUE;
        if (k === "receiver_iban") return BLUE;
        if (k === "amount") return BLUE;
        if (k === "transaction_time") return BLUE;
        return "#00ff9c";
      };

      let out = "";
      for (const k of order) {
        if (!(k in data)) continue;

        const key = (k + "").padEnd(pad, " ");
        let val = data[k];

        if (k === "tr_status") {
          val = statusDisplay(val).text;
        }

        if (k === "receiver_iban") {
          val = formatIban(val); // ‚úÖ no spaces
        }

        const color = valueColor(k, data[k]);
        out += `${escapeHtml(key)}<span style="color:${color}">${escapeHtml(val)}</span>\n`;
      }

      return out.trimEnd();
    }

    function headerBlock(filename, detected) {
      const bank = detected?.bank ?? "Unknown";
      const variant = detected?.variant || "no variant";
      return (
        `FILE :  <span style="color:${BLUE}">${escapeHtml(filename)}</span>\n` +
        `BANK: <span style="color:${BLUE}">${escapeHtml(bank)} (${escapeHtml(variant)})</span>\n\n`
      );
    }

    async function checkPdf() {
      const f = document.getElementById("checkFile")?.files?.[0];
      if (!f) return showPre("‚ùå Pick PDF");

      showPre("‚è≥ Uploading...");
      if (btnSingle) btnSingle.disabled = true;
      if (btnBatch) btnBatch.disabled = true;

      const fd = new FormData();
      fd.append("file", f);

      try {
        const r = await fetch("/check", { method: "POST", body: fd });
        const j = await r.json();

        // Single result as one full-width block
        showPre(headerBlock(f.name, j.detected) + formatData(j.data));
      } catch (e) {
        showPre(`‚ùå Error\n${escapeHtml(String(e))}\n`);
      } finally {
        if (btnSingle) btnSingle.disabled = false;
        if (btnBatch) btnBatch.disabled = false;
      }
    }

    async function checkPdfBatch() {
      const input = document.getElementById("checkFiles");
      const files = Array.from(input?.files || []);
      if (!files.length) return showPre("‚ùå Pick one or more PDFs");

      // Clear previous log
      outEl.innerHTML = "";

      if (btnSingle) btnSingle.disabled = true;
      if (btnBatch) btnBatch.disabled = true;

      // Batch header (full width)
      appendPre(`Batch selected: <span style="color:${BLUE}">${files.length}</span>\n\n`, true);

      // Placeholders first
      const blocks = files.map((f) => appendPre(makeProcessingBlock(f.name)));

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        const fd = new FormData();
        fd.append("file", f);

        try {
          const r = await fetch("/check", { method: "POST", body: fd });
          const j = await r.json();

          blocks[i].innerHTML = headerBlock(f.name, j.detected) + formatData(j.data);
        } catch (e) {
          blocks[i].innerHTML = `‚ùå Error processing ${escapeHtml(f.name)}\n${escapeHtml(String(e))}\n`;
        }

        outEl.scrollTop = outEl.scrollHeight;
      }

      if (btnSingle) btnSingle.disabled = false;
      if (btnBatch) btnBatch.disabled = false;
    }
  </script>
</body>

</html>