<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>PDF Check</title>
  <style>
    .open-btn {
      display: inline-block;
      padding: 4px 10px;
      background: #007bff;
      color: white;
      border-radius: 4px;
      text-decoration: none;
      font-size: 12px;
      margin: 4px 0;
    }

    .open-btn:hover {
      background: #0056b3;
    }
  </style>
</head>

<body style="font-family:Arial;margin:24px">

  <h2> BOT TEST 1</h2>

  <!-- -------- CHECK -------- -->

  <h3>1) Check PDF</h3>

  <input id="checkFile" type="file" accept="application/pdf">
  <button onclick="checkPdf()">Check</button>


  <!-- -------- ADD -------- -->

  <h3 style="margin-top:24px">2) Add to DB</h3>



  <input id="addFile" type="file" accept="application/pdf">
  <button onclick="addPdf()">Add</button>
  <select id="label">
    <option value="real">real</option>
    <option value="fake">fake</option>
  </select>


  <!-- -------- CONTROLS -------- -->

  <div style="margin-top:24px">



    <button onclick="loadDB()">Show Database</button>

  </div>


  <!-- -------- OUTPUT -------- -->
  <h3>Admin</h3>

  <br><br>
  Password:
  <input id="adminPass" type="password">

  <br><br>

  Search:
  <input id="searchBox">
  <button onclick="searchDB()">Search</button>

  <br><br>

  File ID:
  <input id="fileId" style="width:60px">

  <select id="newLabel">
    <option value="real">real</option>
    <option value="fake">fake</option>
  </select>

  <button onclick="showAdminLinks()">Admin Links</button>
  <button onclick="loadAdminLogs()">Show Logs</button>
  <button onclick="updateLabel()">Change Label</button>
  <button onclick="deleteFile()">Delete</button>
  <button onclick="downloadDB()">Download Database</button>
  <hr>

  <div style="margin-top:12px">
    <button onclick="clearLog()">Clear log</button>
  </div>

  <pre id="out" style="
white-space:pre-wrap;
background:#f6f6f6;
padding:12px;
border-radius:8px;
margin-top:12px;
">
</pre>


  <!-- -------- SCRIPT -------- -->

  <script>

    const outEl = document.getElementById("out");

    const show = (text) => {
      outEl.textContent = text;
    };


    function clearLog() {
      outEl.textContent = "";
    }


    // ---------------- CHECK ----------------


    async function checkPdf() {

      const f = document.getElementById("checkFile").files[0];

      if (!f) {
        show("‚ùå Pick a PDF first");
        return;
      }

      // Show processing
      show("‚è≥ Checking PDF... Please wait");

      const fd = new FormData();
      fd.append("file", f);

      try {

        const r = await fetch("/check", {
          method: "POST",
          body: fd
        });

        const j = await r.json();


        // ---- MATCH FOUND ----
        if (j.matched_with) {

          const link = location.origin + j.matched_with.url;

          let html = "";

          html += j.message + "<br><br>";

          html += "Matched with:<br>";
          html += `#${j.matched_with.id} | ${j.matched_with.filename}<br>`;
          html += `<a href="${link}" target="_blank" class="open-btn">Open PDF</a>`;

          outEl.innerHTML = html;

          return;
        }


        // ---- NO MATCH ----
        show(j.message || "Error");


      } catch {

        show("‚ùå Server error while checking");

      }
    }





    // ---------------- ADD ----------------

    async function addPdf() {

      const fileInput = document.getElementById("addFile");
      const labelSelect = document.getElementById("label");
      const passInput = document.getElementById("adminPass");

      const f = fileInput.files[0];
      const label = labelSelect.value;

      if (!f) {
        show("‚ùå Pick a PDF first");
        return;
      }

      // ‚úÖ Show processing
      show("‚è≥ Uploading & saving PDF... Please wait");

      const fd = new FormData();
      fd.append("label", label);
      fd.append("file", f);

      try {

        const r = await fetch("/add", {
          method: "POST",
          body: fd
        });

        const j = await r.json();


        // ---- HANDLE DUPLICATE ----
        if (j.error === "DUPLICATE" && j.existing) {

          const link = location.origin + j.existing.url;

          let html = "";

          html += "‚ùå DUPLICATE NAME: " + j.existing.filename + "<br><br>";
          html += "Already exists:<br>";
          html += `#${j.existing.id} | ${j.existing.label.toUpperCase()} | ${j.existing.filename}<br>`;
          html += `<a href="${link}" target="_blank" class="open-btn">Open PDF</a>`;

          outEl.innerHTML = html;

        } else {

          // ‚úÖ Normal success / error
          show(j.message || "Error");

        }

      } catch {

        show("‚ùå Server error while adding");

      }

      // ‚úÖ ALWAYS reset inputs
      fileInput.value = "";
      labelSelect.value = "real";
      if (passInput) passInput.value = "";
    }





    // ---------------- DATABASE ----------------
    async function loadDB() {

      // Show loading instantly
      outEl.innerHTML = "‚è≥ Loading database...";

      try {

        const r = await fetch("/files");

        if (!r.ok) {
          throw new Error("Server error");
        }

        const list = await r.json();

        if (!list.length) {
          outEl.innerHTML = "üìÇ Database is empty";
          return;
        }

        let html = "<b>üìÇ DATABASE FILES</b><br><br>";

        list.forEach(f => {

          const link = location.origin + "/open/" + f.id;

          html += `#${f.id} | ${f.label.toUpperCase()} | ${f.filename}<br>`;
          html += `<a href="${link}" target="_blank" class="open-btn">Open PDF</a><br><br>`;

        });

        outEl.innerHTML = html;

      } catch (err) {

        console.error(err);

        outEl.innerHTML = "‚ùå Failed to load database";

      }
    }


    // -------- SEARCH --------

    async function searchDB() {

      const q = document.getElementById("searchBox").value;

      const r = await fetch("/search?q=" + encodeURIComponent(q));

      const list = await r.json();

      if (!list.length) {
        show("No results");
        return;
      }

      let out = "SEARCH RESULTS:\n\n";

      list.forEach(f => {

        const link =
          location.origin + "/open/" + f.id;

        out += `#${f.id} | ${f.label} | ${f.filename}\n`;
        out += `Open: ${link}\n\n`;

      });

      show(out);

    }


    // -------- LABEL --------

    async function updateLabel() {

      const idInput = document.getElementById("fileId");
      const passInput = document.getElementById("adminPass");
      const label = document.getElementById("newLabel").value;

      const id = idInput.value.trim();
      const pw = passInput.value.trim();

      if (!id || isNaN(id)) {
        show("‚ùå Enter valid file ID");
        return;
      }

      if (!pw) {
        show("‚ùå Enter admin password");
        return;
      }

      const fd = new FormData();

      fd.append("file_id", id);
      fd.append("label", label);
      fd.append("password", pw);

      try {

        const r = await fetch("/admin/label", {
          method: "POST",
          body: fd
        });

        const j = await r.json();

        show(j.message || JSON.stringify(j));

      } catch {

        show("‚ùå Server error");

      }

      passInput.value = "";
    }


    // -------- DELETE --------

    async function deleteFile() {

      const idInput = document.getElementById("fileId");
      const passInput = document.getElementById("adminPass");

      const id = idInput.value.trim();
      const pw = passInput.value.trim();

      // ---- VALIDATION ----
      if (!id || isNaN(id)) {
        show("‚ùå Enter a valid file ID number");
        return;
      }

      if (!pw) {
        show("‚ùå Enter admin password");
        return;
      }

      const fd = new FormData();

      fd.append("file_id", id);
      fd.append("password", pw);

      try {

        const r = await fetch("/admin/delete", {
          method: "POST",
          body: fd
        });

        const j = await r.json();

        show(j.message || JSON.stringify(j));

      } catch (err) {

        show("‚ùå Server error. Check logs.");

      }

      // ---- RESET PASSWORD ----
      passInput.value = "";
    }



    // -------- ADMIN LINKS --------

    function showAdminLinks() {

      let out = "ADMIN COMMANDS:\n\n";

      out += location.origin + "/admin/reset_db\n";
      out += location.origin + "/admin/logs\n";

      show(out);
    }


    // -------- ADMIN LOGS --------

    async function loadAdminLogs() {

      const r = await fetch("/admin/logs");

      const list = await r.json();

      if (!list.length) {
        show("No admin logs");
        return;
      }

      let out = "ADMIN LOG:\n\n";

      list.forEach(l => {

        out += `[${l.created_at}] ${l.action}`;

        if (l.details) {
          out += " (" + l.details + ")";
        }

        out += "\n";

      });

      show(out);

    }

    // -------- DOWNLOAD DATABASE --------

    function downloadDB() {

      const url = location.origin + "/admin/export";

      window.open(url, "_blank");

    }


  </script>

</body>

</html>