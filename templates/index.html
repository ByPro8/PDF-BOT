<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PDF Check</title>
</head>

<body style="font-family:Arial;margin:24px">

<h2>PDF Template Checker</h2>

<!-- -------- CHECK -------- -->

<h3>1) Check PDF</h3>

<input id="checkFile" type="file" accept="application/pdf">
<button onclick="checkPdf()">Check</button>


<!-- -------- ADD -------- -->

<h3 style="margin-top:24px">2) Add to DB</h3>

<select id="label">
  <option value="good">good</option>
  <option value="bad">bad</option>
</select>

<input id="addFile" type="file" accept="application/pdf">
<button onclick="addPdf()">Add</button>


<!-- -------- CONTROLS -------- -->

<div style="margin-top:24px">

  <button onclick="clearLog()">Clear log</button>

  <button onclick="loadDB()">Show Database</button>

</div>


<!-- -------- OUTPUT -------- -->
<h3>Admin</h3>

Password:
<input id="adminPass" type="password">

<br><br>

Search:
<input id="searchBox">
<button onclick="searchDB()">Search</button>

<br><br>

File ID:
<input id="fileId" style="width:60px">

<select id="newLabel">
  <option value="good">good</option>
  <option value="bad">bad</option>
</select>

<button onclick="updateLabel()">Change Label</button>
<button onclick="deleteFile()">Delete</button>

<hr>


<pre id="out"
style="
white-space:pre-wrap;
background:#f6f6f6;
padding:12px;
border-radius:8px;
margin-top:12px;
">
</pre>


<!-- -------- SCRIPT -------- -->

<script>

const outEl = document.getElementById("out");

const show = (text) => {
  outEl.textContent = text;
};


function clearLog(){
  outEl.textContent = "";
}


// ---------------- CHECK ----------------

async function checkPdf(){

  const f = document.getElementById("checkFile").files[0];

  if(!f){
    show("Pick a PDF first");
    return;
  }

  const fd = new FormData();
  fd.append("file", f);

  const r = await fetch("/check", {
    method: "POST",
    body: fd
  });

  const j = await r.json();

  let text = j.message || "Error";

  if(j.matched_with){

    const link =
      location.origin + j.matched_with.url;

    text += "\n\nMatched with:\n";
    text += j.matched_with.filename + "\n";
    text += link;

  }

  show(text);

}



// ---------------- ADD ----------------

async function addPdf(){

  const f = document.getElementById("addFile").files[0];
  const label = document.getElementById("label").value;

  if(!f){
    show("Pick a PDF first");
    return;
  }

  const fd = new FormData();
  fd.append("label", label);
  fd.append("file", f);

  const r = await fetch("/add", {
    method: "POST",
    body: fd
  });

  const j = await r.json();

  show(j.message || "Error");

}


// ---------------- DATABASE ----------------

async function loadDB(){

  const r = await fetch("/files");
  const list = await r.json();

  if(!list.length){
    show("Database is empty");
    return;
  }

  let out = "DATABASE FILES:\n\n";

  list.forEach(f => {

    const link =
      location.origin + "/open/" + f.id;

    out += `#${f.id} | ${f.label.toUpperCase()} | ${f.filename}\n`;
    out += `Open: ${link}\n\n`;

  });

  show(out);

}

// -------- SEARCH --------

async function searchDB(){

  const q = document.getElementById("searchBox").value;

  const r = await fetch("/search?q=" + encodeURIComponent(q));

  const list = await r.json();

  if(!list.length){
    show("No results");
    return;
  }

  let out = "SEARCH RESULTS:\n\n";

  list.forEach(f=>{

    const link =
      location.origin + "/open/" + f.id;

    out += `#${f.id} | ${f.label} | ${f.filename}\n`;
    out += `Open: ${link}\n\n`;

  });

  show(out);

}


// -------- LABEL --------

async function updateLabel(){

  const id = document.getElementById("fileId").value;
  const label = document.getElementById("newLabel").value;
  const pw = document.getElementById("adminPass").value;

  const fd = new FormData();

  fd.append("file_id", id);
  fd.append("label", label);
  fd.append("password", pw);

  const r = await fetch("/admin/label", {
    method: "POST",
    body: fd
  });

  show(JSON.stringify(await r.json(), null, 2));

}


// -------- DELETE --------

async function deleteFile(){

  const id = document.getElementById("fileId").value;
  const pw = document.getElementById("adminPass").value;

  const fd = new FormData();

  fd.append("file_id", id);
  fd.append("password", pw);

  const r = await fetch("/admin/delete", {
    method: "POST",
    body: fd
  });

  show(JSON.stringify(await r.json(), null, 2));

}



</script>

</body>
</html>
